
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Settings can only be read and written by authenticated admin users.
    match /settings/{docId} {
      allow read, write: if request.auth != null;
    }

    match /tickets/{ticketId} {
      // Allow anyone to create a ticket (for anonymous users starting a chat)
      // and get it if they know the ID.
      // Admins can list all tickets.
      allow create, get: if true;
      allow list, delete: if request.auth != null;
      
      // Allow anyone to update a ticket. This is simplified for the demo app,
      // as the ticket ID is a secret UUID. This allows the app to update
      // the `lastUpdate` timestamp for anonymous users.
      allow update: if true;

      match /messages/{messageId} {
        // Anyone can create a message in a ticket.
        // Anyone can read messages if they know the ticket ID.
        allow create, list, get: if true;
        
        // Messages are immutable.
        allow update, delete: if false;
      }
    }
  }
}
